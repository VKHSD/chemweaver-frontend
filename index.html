<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChemWeaver — SMILES to Gaussian</title>
  <script src="https://unpkg.com/3dmol/build/3Dmol-min.js"></script>
  <style>
    :root{
      --bg:#0f1115; --panel:#151922; --text:#e6e6e6; --muted:#9aa3b2;
      --accent:#7aa2ff; --accent2:#55e9bc; --border:#232838;
      --chip:#0e1526; --chip-br:#273355;
    }
    html,body{height:100%;margin:0}
    body{
      background:var(--bg); color:var(--text);
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      display:grid; grid-template-rows:auto 1fr;
    }
    header{
      display:flex; gap:12px; align-items:center;
      padding:10px 14px; border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,#121521,#0f1115);
    }
    header h1{font-size:16px;margin:0}
    .muted{color:var(--muted);font-size:12px}
    .wrap{display:grid; grid-template-columns:380px 1fr 420px; height:calc(100vh - 56px)}
    .left,.right{padding:12px; background:var(--panel); overflow:auto}
    .left{border-right:1px solid var(--border)}
    .right{border-left:1px solid var(--border); display:flex; flex-direction:column; gap:10px; min-width:0}
    .viewer{position:relative}
    #viewer{position:absolute; inset:0}
    .row{display:flex; gap:8px; align-items:center; margin:8px 0}
    .row input[type="text"]{flex:1; min-width:0}
    .btn{background:#1c2232; color:var(--text); border:1px solid var(--border);
         padding:8px 10px; border-radius:10px; font-size:13px; cursor:pointer}
    .btn:hover{border-color:#2b3653; transform:translateY(-1px)}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; background:var(--chip); border:1px solid var(--chip-br); color:#cfe0ff; font-size:12px}
    input,textarea{background:#0e111a; color:#e6e6e6; border:1px solid var(--border); border-radius:8px; padding:8px}
    label{font-size:13px; color:var(--muted)}
    .help{font-size:12px; color:var(--muted)}
    details.card{border:1px solid var(--border); border-radius:10px; background:#101522}
    details.card>summary{list-style:none; cursor:pointer; padding:10px 12px; color:#cfe0ff; display:flex; justify-content:space-between}
    details.card[open]>summary{border-bottom:1px solid var(--border)}
    details.card .content{padding:10px 12px; display:flex; flex-direction:column; gap:8px}
    pre#gjf{white-space:pre; background:#0e111a; border:1px solid var(--border); border-radius:8px; padding:10px; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12px; min-height:220px; overflow:auto}
    .status{position:absolute; left:10px; bottom:10px; background:rgba(20,24,35,.85); border:1px solid #2a3250; border-radius:10px; padding:8px 10px; font-size:12px; pointer-events:none}
    a{color:var(--accent2); text-decoration:none} a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <header>
    <h1>ChemWeaver</h1>
    <div class="muted">One box: type a SMILES or a name/CAS/InChIKey.</div>
    <span class="pill" id="count">No model</span>
  </header>

  <div class="wrap">
    <div class="left">
      <details class="card" open>
        <summary>Lookup & Input</summary>
        <div class="content">
          <div class="row">
            <label style="min-width:70px">Query</label>
            <input id="query" type="text" placeholder="e.g., C1=CC=CC=C1  or  aspirin  or  50-78-2  or  UHOVQNZJYSORNB-UHFFFAOYSA-N" />
          </div>
          <div class="row">
            <button class="btn" id="btnPreview">Preview 3D</button>
            <button class="btn" id="btnClear">Clear</button>
          </div>
          <div class="help">Client resolves via PubChem first (CORS ok), then falls back to backend. Backend builds 3D/Gaussian.</div>
        </div>
      </details>

      <details class="card">
        <summary>Export</summary>
        <div class="content">
          <div class="row">
            <label>%chk name</label>
            <input id="chkname" type="text" placeholder="e.g. C6H6" />
          </div>
          <div class="row">
            <label>Header</label>
            <textarea id="header" rows="3" placeholder="# opt freq B3LYP/6-31G(d) geom=connectivity"></textarea>
          </div>
          <div class="row">
            <label>Title</label>
            <input id="title" type="text" placeholder="Generated by ChemWeaver" />
          </div>
          <div class="row">
            <label><input id="includeConn" type="checkbox" checked /> Include connectivity</label>
          </div>
          <div class="row">
            <button class="btn" id="btnBuild">Build GJF (backend)</button>
            <button class="btn" id="btnDownload">Download .gjf</button>
          </div>
          <div class="help">Aromatic=1.5, double=2.0, triple=3.0 are preserved.</div>
        </div>
      </details>

      <details class="card">
        <summary>Style</summary>
        <div class="content">
          <div class="row">
            <label>Sphere radius</label><input id="srad" type="range" min="0.1" max="0.7" step="0.01" value="0.35" />
          </div>
          <div class="row">
            <label>Stick radius</label><input id="trad" type="range" min="0.05" max="0.3" step="0.01" value="0.12" />
          </div>
          <div class="row">
            <label><input id="labels" type="checkbox" checked /> Show atom numbers</label>
          </div>
        </div>
      </details>
    </div>

    <div class="viewer">
      <div id="viewer"></div>
      <div id="status" class="status" hidden></div>
    </div>

    <div class="right">
      <details class="card" open>
        <summary>Gaussian Preview</summary>
        <div class="content">
          <pre id="gjf">(none)</pre>
        </div>
      </details>
    </div>
  </div>

<script>
/* ---------- config ---------- */
const BACKEND = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
  ? 'http://127.0.0.1:5000'
  : 'https://chemweaver-backend-1.onrender.com';

/* ---------- 3D viewer ---------- */
let viewer, model, labels=[];
let lastSMILES = "";

function initViewer(){
  const el = document.getElementById('viewer');
  viewer = $3Dmol.createViewer(el, { backgroundColor:'#0c0f16' });
  viewer.zoomTo(); viewer.render();
  window.addEventListener('resize', ()=>viewer.resize());
}
function showStatus(msg, ms=3500){
  const s=document.getElementById('status');
  s.textContent = msg; s.hidden=false;
  clearTimeout(showStatus._t); showStatus._t=setTimeout(()=>s.hidden=true, ms);
}

/* ---------- labels & styles ---------- */
function clearLabels(){
  for(const l of labels||[]) viewer.removeLabel(l);
  labels.length = 0;
}
function updateLabels(){
  clearLabels();
  if(!document.getElementById('labels').checked || !model){ viewer.render(); return; }
  const atoms = model.selectedAtoms({});
  atoms.forEach((a,i)=>{
    const serial = (a.serial ?? (Number.isFinite(a.index) ? a.index+1 : i+1));
    labels.push(viewer.addLabel(String(serial), {
      position:{x:a.x,y:a.y,z:a.z}, fontSize:12, backgroundOpacity:0, fontColor:'white'
    }));
  });
  viewer.render();
}
function setStyles(){
  if(!model) return;
  const srad = parseFloat(document.getElementById('srad').value);
  const trad = parseFloat(document.getElementById('trad').value);
  model.setStyle({}, {stick:{radius:trad}, sphere:{radius:srad}});
  viewer.render(); updateLabels();
}

/* ---------- load into viewer ---------- */
function applyModelAndRender(newModel){
  model = newModel;
  setStyles();
  viewer.zoomTo();
  viewer.render();
  const n = model.selectedAtoms({}).length;
  document.getElementById('count').textContent = `${n} atoms`;
  updateLabels();
}
async function loadSDFIntoViewer(sdfText){
  viewer.removeAllModels?.(); clearLabels();
  const m = viewer.addModel(sdfText,'sdf');
  applyModelAndRender(m);
}

/* ---------- client-side PubChem resolve ---------- */
async function pcJSON(url, abortMs=8000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), abortMs);
  const r = await fetch(url, { headers:{'Accept':'application/json'}, signal: ctrl.signal });
  clearTimeout(t);
  if(!r.ok) throw new Error('HTTP '+r.status);
  const js = await r.json();
  const fault = js?.Fault?.Details?.[0] || js?.Fault?.Message;
  if(fault) throw new Error(String(fault));
  return js;
}
async function resolveClientFirst(query){
  const q = query.trim();
  if(!q) throw new Error('empty');
  const enc = encodeURIComponent(q);
  const isInChIKey = /^[A-Z]{14}-[A-Z]{10}-[A-Z]$/i.test(q);
  const isCAS     = /^\d{2,7}-\d{2}-\d$/.test(q);

  // If it's already SMILES, accept it
  // We can’t validate offline here; let backend validate when building
  if(!isInChIKey && !isCAS && /[=#()\[\]@+\-\dA-Za-z\\\/]/.test(q) && q.includes('=') || q.includes('#') || q.match(/[a-z][a-z]/i)){
    // heuristic allow-through if looks like SMILES; still try PubChem if name
  }

  try{
    if(isInChIKey){
      const js = await pcJSON(`https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/inchikey/${enc}/property/IsomericSMILES,CanonicalSMILES/JSON`);
      const p = js?.PropertyTable?.Properties?.[0];
      if(p?.IsomericSMILES) return p.IsomericSMILES;
      if(p?.CanonicalSMILES) return p.CanonicalSMILES;
      throw new Error('No SMILES for that InChIKey');
    }

    if(isCAS){
      try{
        const js = await pcJSON(`https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/xref/rn/${enc}/property/IsomericSMILES,CanonicalSMILES/JSON`);
        const p = js?.PropertyTable?.Properties?.[0];
        if(p?.IsomericSMILES) return p.IsomericSMILES;
        if(p?.CanonicalSMILES) return p.CanonicalSMILES;
      }catch(_){}
      const cj = await pcJSON(`https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/xref/rn/${enc}/cids/JSON`);
      const cid = cj?.IdentifierList?.CID?.[0];
      if(cid){
        const pj = await pcJSON(`https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/${cid}/property/IsomericSMILES,CanonicalSMILES/JSON`);
        const p = pj?.PropertyTable?.Properties?.[0];
        if(p?.IsomericSMILES) return p.IsomericSMILES;
        if(p?.CanonicalSMILES) return p.CanonicalSMILES;
      }
      throw new Error('No SMILES for that CAS RN');
    }

    // Name
    try{
      const js = await pcJSON(`https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${enc}/property/IsomericSMILES,CanonicalSMILES/JSON`);
      const p = js?.PropertyTable?.Properties?.[0];
      if(p?.IsomericSMILES) return p.IsomericSMILES;
      if(p?.CanonicalSMILES) return p.CanonicalSMILES;
    }catch(_){}

    const cj = await pcJSON(`https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${enc}/cids/JSON`);
    const cid = cj?.IdentifierList?.CID?.[0];
    if(cid){
      const pj = await pcJSON(`https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/${cid}/property/IsomericSMILES,CanonicalSMILES/JSON`);
      const p = pj?.PropertyTable?.Properties?.[0];
      if(p?.IsomericSMILES) return p.IsomericSMILES;
      if(p?.CanonicalSMILES) return p.CanonicalSMILES;
    }

    throw new Error('Could not resolve via PubChem');
  }catch(e){
    // If it *looks* like SMILES, just pass it through to backend
    if(/^[A-Za-z0-9@\+\-\[\]\(\)=#\\\/.%]+$/.test(q) && /[A-Za-z]/.test(q)) return q;
    throw e;
  }
}

/* ---------- backend calls ---------- */
async function resolveAnyBackendGET(query){
  const url = `${BACKEND}/api/resolve_any?query=${encodeURIComponent(query)}`;
  const r = await fetch(url, { method: 'GET' });
  const js = await r.json().catch(()=>({}));
  if(!r.ok || !js?.smiles) throw new Error(js?.error || `resolve_any HTTP ${r.status}`);
  return js.smiles;
}

async function buildSDF(smiles){
  const r = await fetch(`${BACKEND}/api/smiles2sdf`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ smiles })
  });
  if(!r.ok){
    const txt = await r.text().catch(()=> '');
    throw new Error(`Backend 3D failed${txt ? ': '+txt : ''}`);
  }
  return await r.text();
}

async function buildGJFUsingUI(smiles){
  const chk = (document.getElementById('chkname').value || '').trim();
  const headerRaw = (document.getElementById('header').value || '# opt freq B3LYP/6-31G(d) geom=connectivity').trim();
  const title = (document.getElementById('title').value || 'Generated by ChemWeaver').trim();
  const includeConn = document.getElementById('includeConn').checked;
  const header = (chk ? `%chk=${chk}.chk\n` : '') + headerRaw;

  const r = await fetch(`${BACKEND}/api/gjf`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ smiles, header, title, include_connectivity: includeConn })
  });
  if(!r.ok){
    const txt = await r.text().catch(()=> '');
    throw new Error(`Backend /api/gjf failed${txt ? ': '+txt : ''}`);
  }
  const gjf = await r.text();
  document.getElementById('gjf').textContent = gjf;
  showStatus('GJF ready (preview updated).');
}

/* ---------- events ---------- */
function hookUI(){
  document.getElementById('btnPreview').addEventListener('click', async ()=>{
    const query = document.getElementById('query').value.trim();
    if(!query){ showStatus('Enter a SMILES or a name.'); return; }

    try{
      showStatus('Resolving → SMILES (client)…');
      let smiles;
      try{
        smiles = await resolveClientFirst(query);
      }catch(_){
        showStatus('Client resolve failed; trying backend…');
        smiles = await resolveAnyBackendGET(query);
      }
      lastSMILES = smiles;

      showStatus('Building 3D…');
      const sdf = await buildSDF(smiles);
      await loadSDFIntoViewer(sdf);
      showStatus('Loaded 3D.');
    }catch(e){
      console.warn(e);
      showStatus('Error: ' + (e?.message || e));
    }
  });

  document.getElementById('btnBuild').addEventListener('click', async ()=>{
    if(!lastSMILES){ showStatus('Preview first to resolve to SMILES.'); return; }
    try{
      showStatus('Backend → building Gaussian…');
      await buildGJFUsingUI(lastSMILES);
    }catch(e){
      console.warn(e);
      showStatus('Backend unavailable or build failed.');
    }
  });

  document.getElementById('btnDownload').addEventListener('click', ()=>{
    const txt = document.getElementById('gjf').textContent || '';
    if(!txt.trim()){ showStatus('Build the GJF first.'); return; }
    const m = txt.match(/^%chk=([^\r\n]+?)\.chk/m);
    const name = m ? m[1] : 'molecule';
    const blob = new Blob([txt], {type:'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name + '.gjf';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(a.href);
  });

  document.getElementById('btnClear').addEventListener('click', ()=>{
    viewer.removeAllModels?.(); model=null; clearLabels(); viewer.render();
    document.getElementById('gjf').textContent='(none)';
    document.getElementById('count').textContent='No model';
    lastSMILES = "";
  });

  document.getElementById('srad').addEventListener('input', setStyles);
  document.getElementById('trad').addEventListener('input', setStyles);
  document.getElementById('labels').addEventListener('change', updateLabels);

  document.getElementById('query').addEventListener('keydown', (e)=>{
    if(e.key==='Enter') document.getElementById('btnPreview').click();
  });
}

/* ---------- boot ---------- */
window.addEventListener('DOMContentLoaded', ()=>{
  initViewer();
  hookUI();
  document.getElementById('header').value = '# opt freq B3LYP/6-31G(d) geom=connectivity';
});
</script>
</body>
</html>
